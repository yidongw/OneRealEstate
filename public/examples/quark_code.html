<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>QuarkChain DApp Example</title>
  <script src="https://cdn.jsdelivr.net/npm/quarkchain-web3@0.2.0/dist/quarkchain-web3.js"></script>
</head>

<body>
  <h1>Send Tx</h1>
  <form id="sendTxForm">
    <br> To:
    <br>
    <input type="text" name="to" value="0x2f3De25eD3Aa557AFc32f28b1fd164b0c77a64150Aafc85D">
    <br> Value (wei):
    <br>
    <input type="text" name="value" value="0">
    <br>
    <input type="button" value="Send Tx" onclick="sendTx()">
  </form>
</body>

<script type="text/javascript">
  (function () {

    if (typeof web3 === 'undefined') {
      const msg = "Couldn't detect web3. Make sure MetaMask is installed.";
      alert(msg);
      console.error(msg);
      return;
    }

    QuarkChain.injectWeb3(web3, "http://jrpc.testnet.quarkchain.io:38391");
  })();

  async function sendTx() {

    const ethAddr = web3.eth.accounts[0];
    const qkcAddr = QuarkChain.getQkcAddressFromEthAddress(ethAddr);

    const formEle = document.getElementById("sendTxForm");
    const rawTx = {
      gas: `0x${(30000).toString(16)}`,
      gasPrice: "0x00",
      data: "0x",
      // Update according to the form.
      to: "",
      value: "",
    };
    for (let i = 0; i < formEle.length; i += 1) {
      const element = formEle.elements[i];
      switch (element.name) {
        case "to":
          if (element.value.length !== 50) {
            throw new Error("Invalid QKC address");
          }
          rawTx.to = element.value;
          break;
        case "value":
          rawTx.value = `0x${Number(element.value).toString(16)}`;
          break;
      }
    }

    let abi = [
      {
        "constant": true,
        "inputs": [
          {
            "name": "",
            "type": "uint256"
          }
        ],
        "name": "RecordsKeys",
        "outputs": [
          {
            "name": "",
            "type": "uint256"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [
          {
            "name": "_listingid",
            "type": "uint256"
          }
        ],
        "name": "getRecordByListingid",
        "outputs": [
          {
            "name": "",
            "type": "uint256"
          },
          {
            "name": "",
            "type": "string"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "constant": false,
        "inputs": [
          {
            "name": "_listingid",
            "type": "uint256"
          },
          {
            "name": "_id",
            "type": "uint256"
          },
          {
            "name": "_documentHash",
            "type": "string"
          }
        ],
        "name": "setRecord",
        "outputs": [],
        "payable": false,
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "getAllRecords",
        "outputs": [
          {
            "name": "",
            "type": "uint256[]"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      },
      {
        "constant": true,
        "inputs": [],
        "name": "countRecords",
        "outputs": [
          {
            "name": "",
            "type": "uint256"
          }
        ],
        "payable": false,
        "stateMutability": "view",
        "type": "function"
      }
    ];


    let sampleContract = web3.qkc.contract(abi);

    let contractAddress = '0x2f3De25eD3Aa557AFc32f28b1fd164b0c77a64150Aafc85D';
    let sampleContractInstance = sampleContract.at(contractAddress);

    let readOption = {
      fromFullShardId: '0x0Aafc85D',
    };

    sampleContractInstance.countRecords(readOption, (err, result) => {
      if (result != null) {
        console.log("countRecords: ", result.toNumber());
      } else {
        console.err("countRecords errors");
      }
    });

    sampleContractInstance.getAllRecords(readOption, (err, result) => {
      if (result != null) {
        console.log("getAllRecords: ", result);
      } else {
        console.err("getAllRecords errors");
      }
    });

    sampleContractInstance.setRecord(5, 5, "test2", {
        gas: 1000000,
        fromFullShardId: '0x0Aafc85D',
        //from: web3.eth.accounts[0],
        //value: web3.toWei(0.1, 'ether')
      }, console.log);

    // Should be able to find tx ID in console.
    //await web3.qkc.sendTransaction(rawTx, console.log);
  }
</script>

</html>
